<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ — Каталог домов</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="admin.css">
</head>
<body class="admin-page">
  <div class="admin-container">
    <h1>Админ-панель</h1>

    <div class="admin-card">
      <h2>Добавить проект по ID</h2>
      <p>Введи ID проекта с сайта строим.дом.рф — карточка создастся автоматически.</p>
      <form id="add-one-form" class="admin-form">
        <label for="project-id">ID проекта</label>
        <input type="text" id="project-id" placeholder="Например: 77279" inputmode="numeric" pattern="[0-9]+">
        <button type="submit" class="admin-btn admin-btn-primary" id="add-one-btn">Добавить проект</button>
      </form>
      <div id="add-one-msg" class="admin-msg" role="status"></div>
    </div>

    <div class="admin-card">
      <h2>Заполнить каталог по списку ID</h2>
      <p>Несколько ID через запятую — все проекты подтянутся с строим.дом.рф.</p>
      <form id="batch-form" class="admin-form">
        <label for="project-ids">ID через запятую</label>
        <textarea id="project-ids" placeholder="77279, 12345, 67890"></textarea>
        <button type="submit" class="admin-btn admin-btn-primary" id="batch-btn">Заполнить каталог</button>
      </form>
      <div id="batch-msg" class="admin-msg" role="status"></div>
    </div>

    <div class="admin-card">
      <h2>Список проектов</h2>
      <p>Загрузи список и редактируй фото каждого проекта.</p>
      <button id="load-projects-btn" class="admin-btn admin-btn-secondary">Загрузить список</button>
      <div id="projects-list" class="admin-table-wrap" style="margin-top: 1rem;"></div>
    </div>

    <div class="admin-card">
      <h2>Удалить проекты</h2>
      <p>По ID или по названию.</p>
      <form id="delete-batch-form" class="admin-form">
        <label for="delete-project-ids">ID проектов (через запятую)</label>
        <input type="text" id="delete-project-ids" placeholder="20113, 12345">
        <button type="submit" class="admin-btn admin-btn-danger admin-btn-sm">Удалить по ID</button>
      </form>
      <div id="delete-batch-msg" class="admin-msg" role="status"></div>
      <form id="delete-by-names-form" class="admin-form" style="margin-top: 1.5rem;">
        <label for="delete-names">Или по названию (каждое с новой строки)</label>
        <textarea id="delete-names" rows="4" placeholder="Название проекта 1&#10;Название проекта 2"></textarea>
        <button type="submit" class="admin-btn admin-btn-danger admin-btn-sm">Удалить по названию</button>
      </form>
      <div id="delete-by-names-msg" class="admin-msg" role="status"></div>
    </div>

    <div class="admin-card">
      <h2>Обновить проекты</h2>
      <p>Перепарсить все проекты с строим.дом.рф — фото, планировки, материал. Занимает 2–5 мин.</p>
      <button id="reparse-materials-btn" class="admin-btn admin-btn-secondary">Обновить все проекты</button>
      <div id="reparse-materials-msg" class="admin-msg" role="status"></div>
    </div>

    <div class="admin-card">
      <h2>База пользователей</h2>
      <button id="load-users-btn" class="admin-btn admin-btn-secondary">Обновить список</button>
      <div id="users-list" style="margin-top: 1rem;"></div>
    </div>

    <a href="index.html" class="admin-link">← Вернуться в каталог</a>
  </div>

  <!-- Модалка редактирования фото -->
  <div class="edit-photo-modal" id="edit-photo-modal" style="display: none;">
    <div class="edit-photo-content">
      <h2>Фото проекта <span id="edit-project-name"></span></h2>
      <p class="photo-count" id="edit-photo-count">0 фото</p>

      <h3>Текущие фото</h3>
      <div id="edit-photos-grid" class="photos-grid"></div>

      <h3>Добавить фото</h3>
      <label class="upload-zone" for="edit-photos-input">
        <span>Выбери файлы или перетащи сюда</span>
        <input type="file" id="edit-photos-input" accept="image/*" multiple>
      </label>
      <button type="button" id="edit-add-photos-btn" class="admin-btn admin-btn-primary" style="margin-top: 0.75rem; display: none;">Добавить выбранные</button>

      <div id="edit-project-msg" class="admin-msg" role="status"></div>
      <button type="button" id="edit-close-btn" class="admin-btn admin-btn-secondary" style="margin-top: 1.5rem;">Закрыть</button>
    </div>
  </div>

  <script>
    const API_URL = (window.location.origin || 'http://localhost:3000').replace(/\/$/, '') + '/api';

    const showMsg = (el, text, isError) => {
      el.textContent = text;
      el.className = 'admin-msg ' + (isError ? 'error' : 'success');
      el.style.display = 'block';
    };

    document.getElementById('add-one-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('project-id').value.trim().replace(/\D/g, '');
      const btn = document.getElementById('add-one-btn');
      const msg = document.getElementById('add-one-msg');
      if (!id) {
        showMsg(msg, 'Введи числовой ID проекта.', true);
        return;
      }
      btn.disabled = true;
      msg.style.display = 'none';
      try {
        const res = await fetch(`${API_URL}/parse/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showMsg(msg, data.message === 'Project updated' ? 'Проект обновлён.' : 'Проект добавлен.');
        } else {
          showMsg(msg, data.error || 'Ошибка добавления.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    document.getElementById('batch-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const raw = document.getElementById('project-ids').value.trim();
      const ids = raw.split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
      const btn = document.getElementById('batch-btn');
      const msg = document.getElementById('batch-msg');
      if (ids.length === 0) {
        showMsg(msg, 'Введи хотя бы один ID.', true);
        return;
      }
      btn.disabled = true;
      msg.style.display = 'none';
      try {
        const res = await fetch(`${API_URL}/parse-batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectIds: ids }),
        });
        const data = await res.json();
        if (data.success) {
          showMsg(msg, `Добавлено: ${data.created}, обновлено: ${data.updated}.${data.failed?.length ? ' Не найдены: ' + data.failed.join(', ') : ''}`, data.failed?.length > 0);
        } else {
          showMsg(msg, data.error || 'Ошибка.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    const loadUsers = async () => {
      const list = document.getElementById('users-list');
      list.innerHTML = '<p style="color:#64748b;">Загрузка...</p>';
      try {
        const res = await fetch(`${API_URL}/users`);
        const data = await res.json();
        if (data.success && data.data.length > 0) {
          list.innerHTML = `
            <div class="admin-table-wrap">
              <table class="admin-table">
                <thead><tr><th>ID</th><th>Ник</th><th>Имя</th><th>Визитов</th></tr></thead>
                <tbody>
                  ${data.data.map(u => `
                    <tr>
                      <td>${u.telegram_id}</td>
                      <td>${u.username || '-'}</td>
                      <td>${[u.first_name, u.last_name].filter(Boolean).join(' ') || '-'}</td>
                      <td>${u.visit_count || 0}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          list.innerHTML = '<p style="color:#64748b;">Пользователей пока нет</p>';
        }
      } catch (err) {
        list.innerHTML = '<p style="color:#b91c1c;">Ошибка загрузки</p>';
      }
    };

    document.getElementById('delete-batch-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const raw = document.getElementById('delete-project-ids').value.trim();
      const ids = raw.split(/[\s,]+/).map(s => parseInt(s.replace(/\D/g, ''))).filter(n => !isNaN(n));
      const btn = document.getElementById('delete-batch-btn');
      const msg = document.getElementById('delete-batch-msg');
      if (ids.length === 0) {
        showMsg(msg, 'Введи хотя бы один project_id.', true);
        return;
      }
      if (!confirm(`Удалить ${ids.length} проект(ов)?`)) return;
      btn.disabled = true;
      try {
        const res = await fetch(`${API_URL}/projects/delete-batch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectIds: ids }),
        });
        const data = await res.json();
        if (data.success) {
          showMsg(msg, `Удалено: ${data.deleted} проект(ов).`);
          document.getElementById('delete-project-ids').value = '';
        } else {
          showMsg(msg, data.error || 'Ошибка.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    document.getElementById('delete-by-names-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const raw = document.getElementById('delete-names').value.trim();
      const names = raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
      const btn = document.getElementById('delete-by-names-btn');
      const msg = document.getElementById('delete-by-names-msg');
      if (names.length === 0) {
        showMsg(msg, 'Введи хотя бы одно название.', true);
        return;
      }
      if (!confirm(`Удалить проекты по ${names.length} запросу(ам)?`)) return;
      btn.disabled = true;
      try {
        const res = await fetch(`${API_URL}/projects/delete-by-names`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ names }),
        });
        const data = await res.json();
        if (data.success) {
          showMsg(msg, `Удалено: ${data.deleted} проект(ов).`);
          if (data.deleted > 0) document.getElementById('delete-names').value = '';
        } else {
          showMsg(msg, data.error || 'Ошибка.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    document.getElementById('reparse-materials-btn').addEventListener('click', async () => {
      const btn = document.getElementById('reparse-materials-btn');
      const msg = document.getElementById('reparse-materials-msg');
      btn.disabled = true;
      msg.textContent = 'Запуск обновления...';
      msg.className = 'admin-msg success';
      msg.style.display = 'block';
      try {
        const res = await fetch(`${API_URL}/reparse-materials`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          showMsg(msg, data.message || 'Обновление запущено.');
        } else {
          showMsg(msg, data.error || 'Ошибка.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    const loadProjects = async () => {
      const list = document.getElementById('projects-list');
      list.innerHTML = '<p style="color:#64748b;">Загрузка...</p>';
      try {
        const res = await fetch(`${API_URL}/projects?limit=500`);
        const data = await res.json();
        if (data.success && data.data?.length > 0) {
          list.innerHTML = `
            <table class="admin-table">
              <thead>
                <tr><th>ID</th><th>Название</th><th></th></tr>
              </thead>
              <tbody>
                ${data.data.map((p) => `
                  <tr>
                    <td>${p.project_id}</td>
                    <td>${(p.name || '-').substring(0, 45)}</td>
                    <td>
                      <button type="button" class="admin-btn admin-btn-primary admin-btn-sm edit-photo-btn" data-id="${p.project_id}" data-name="${(p.name || '-').replace(/"/g, '&quot;').substring(0, 50)}">Фото</button>
                      <button type="button" class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteProject(${p.project_id}, this)">Удалить</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          list.innerHTML = '<p style="color:#64748b;">Проектов нет</p>';
        }
      } catch (err) {
        list.innerHTML = '<p style="color:#b91c1c;">Ошибка загрузки</p>';
      }
    };

    window.deleteProject = async (projectId, btn) => {
      if (!confirm(`Удалить проект ${projectId}?`)) return;
      btn.disabled = true;
      try {
        const res = await fetch(`${API_URL}/projects/${projectId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) loadProjects();
        else alert(data.error || 'Ошибка');
      } catch (e) {
        alert('Ошибка сети');
      }
      btn.disabled = false;
    };

    let currentEditProjectId = null;
    let currentEditImages = [];

    const renderPhotosGrid = () => {
      const grid = document.getElementById('edit-photos-grid');
      document.getElementById('edit-photo-count').textContent = `${currentEditImages.length} фото`;
      grid.innerHTML = currentEditImages.map((src, i) => {
        const isData = src.startsWith('data:');
        return `
          <div class="photo-item">
            <img src="${isData ? src : 'https://wsrv.nl/?url=' + encodeURIComponent(src)}" alt="" onerror="this.style.background='#f1f5f9';this.alt='Не загружается'">
            <button type="button" class="photo-remove" data-index="${i}" title="Удалить">×</button>
          </div>
        `;
      }).join('');
      grid.querySelectorAll('.photo-remove').forEach((b) => {
        b.addEventListener('click', async () => {
          const idx = parseInt(b.dataset.index, 10);
          const res = await fetch(`${API_URL}/projects/${currentEditProjectId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ removeImageAtIndex: idx }),
          });
          const data = await res.json();
          if (data.success) {
            currentEditImages.splice(idx, 1);
            renderPhotosGrid();
            showMsg(document.getElementById('edit-project-msg'), 'Фото удалено.', false);
          } else {
            showMsg(document.getElementById('edit-project-msg'), data.error || 'Ошибка удаления.', true);
          }
        });
      });
    };

    const openEditModal = async (projectId, projectName) => {
      currentEditProjectId = projectId;
      document.getElementById('edit-project-name').textContent = projectName || projectId;
      document.getElementById('edit-photos-input').value = '';
      document.getElementById('edit-add-photos-btn').style.display = 'none';
      document.getElementById('edit-project-msg').style.display = 'none';
      document.getElementById('edit-photo-modal').style.display = 'flex';

      const res = await fetch(`${API_URL}/projects/${projectId}`);
      const data = await res.json();
      if (data.success) {
        currentEditImages = Array.isArray(data.data.images) ? [...data.data.images] : [];
        renderPhotosGrid();
      } else {
        currentEditImages = [];
        renderPhotosGrid();
      }
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.edit-photo-btn');
      if (btn) openEditModal(parseInt(btn.dataset.id, 10), btn.dataset.name);
    });

    document.getElementById('edit-close-btn').addEventListener('click', () => {
      document.getElementById('edit-photo-modal').style.display = 'none';
      currentEditProjectId = null;
    });

    const uploadZone = document.querySelector('.upload-zone');
    const photosInput = document.getElementById('edit-photos-input');
    photosInput.addEventListener('change', (e) => {
      document.getElementById('edit-add-photos-btn').style.display = (e.target.files?.length > 0) ? 'inline-flex' : 'none';
    });
    uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files?.length) {
        photosInput.files = e.dataTransfer.files;
        document.getElementById('edit-add-photos-btn').style.display = 'inline-flex';
      }
    });

    document.getElementById('edit-add-photos-btn').addEventListener('click', async () => {
      const input = document.getElementById('edit-photos-input');
      const msg = document.getElementById('edit-project-msg');
      const btn = document.getElementById('edit-add-photos-btn');
      if (!currentEditProjectId || !input.files || input.files.length === 0) return;
      btn.disabled = true;
      msg.style.display = 'none';
      const files = Array.from(input.files);
      const dataUrls = [];
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        const dataUrl = await new Promise((resolve) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.readAsDataURL(f);
        });
        if (dataUrl.length < 800000) dataUrls.push(dataUrl);
      }
      if (dataUrls.length === 0) {
        showMsg(msg, 'Нет подходящих фото (jpg/png, до 800 КБ).', true);
        btn.disabled = false;
        return;
      }
      try {
        const res = await fetch(`${API_URL}/projects/${currentEditProjectId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ appendImages: dataUrls }),
        });
        const data = await res.json();
        if (data.success) {
          const added = data.data?.added ?? dataUrls.length;
          const total = data.data?.total ?? (currentEditImages.length + dataUrls.length);
          currentEditImages = [...currentEditImages, ...dataUrls];
          renderPhotosGrid();
          showMsg(msg, `Добавлено ${added} фото. Всего: ${total}`, false);
          input.value = '';
          document.getElementById('edit-add-photos-btn').style.display = 'none';
        } else {
          showMsg(msg, data.error || 'Ошибка.', true);
        }
      } catch (err) {
        showMsg(msg, 'Ошибка сети или сервера.', true);
      }
      btn.disabled = false;
    });

    document.getElementById('load-projects-btn').addEventListener('click', loadProjects);
    document.getElementById('load-users-btn').addEventListener('click', loadUsers);
    loadUsers();
  </script>
</body>
</html>
